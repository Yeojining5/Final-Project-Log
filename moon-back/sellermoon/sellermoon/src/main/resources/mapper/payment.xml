<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mybatis.mapper.paymentMapper">
	<resultMap type="kh.sellermoon.member.vo.PaymentVO" id="paymentMap"></resultMap>
	<insert id="paymentInsert" parameterType="map">
		<!--  INSERT
        INTO TB_ORDER(ORDER_NO,MEMBER_NO,CART_NO,ORDER_PAYMENT,ORDER_DATE
        ,ORDER_AMOUNT,ORDER_USED_POINT)
        VALUES(#{ORDER_NO},#{MEMBER_NO},#{CART_NO}
        ,#{ORDER_PAYMENT},#{ORDER_DATE},#{ORDER_AMOUNT}
        ,#{ORDER_USED_POINT}) -->
        
  <!--      INSERT ALL
        INTO TB_ORDER (ORDER_NO, MEMBER_NO, CART_NO, ORDER_PAYMENT
        , ORDER_DATE, ORDER_AMOUNT, ORDER_USED_POINT)
        VALUES(#{ORDER_NO}, #{MEMBER_NO},#{CART_NO}, #{ORDER_PAYMENT}
        ,to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS'), #{ORDER_AMOUNT}, #{ORDER_USED_POINT})
        INTO TB_PURCHASE (PURCHASE_NO, ORDER_NO, PURCHASE_METHOD)
        VALUES( #{PURCHASE_NO}, #{ORDER_NO}, #{PURCHASE_METHOD})
        SELECT * FROM DUAL  -->
        
  INSERT ALL
        INTO TB_ORDER (ORDER_NO, MEMBER_NO, CART_NO, ORDER_PAYMENT
        , ORDER_DATE, ORDER_AMOUNT, ORDER_USED_POINT)
        VALUES(#{ORDER_NO}, #{MEMBER_NO},#{CART_NO}, #{ORDER_PAYMENT}
        ,to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS'), #{ORDER_AMOUNT}, #{ORDER_USED_POINT})
        INTO TB_PURCHASE (PURCHASE_NO, ORDER_NO, PURCHASE_METHOD)
        VALUES(#{PURCHASE_NO}, #{ORDER_NO}, #{PURCHASE_METHOD})
         INTO TB_ORDER_DE   (ORDER_DE_NO, ORDER_NO, ORDER_DE_QUANTITY
         ,ORDER_DE_PRICE,ORDER_DE_CANCEL)
        VALUES(#{ORDER_DE_NO}, #{ORDER_NO}, #{ORDER_DE_QUANTITY}
        , #{ORDER_DE_PRICE}, #{ORDER_DE_CANCEL})
         INTO TB_DELIVERY  (DELIVERY_STATUS, ORDER_NO)
        VALUES(#{DELIVERY_STATUS}, #{ORDER_NO}) 
        SELECT * FROM DUAL 
        
	</insert>

	<select id="paymentList" parameterType="map" resultType="java.util.Map">	
		SELECT car.member_no, car.cart_no, car.order_type, car.cart_quantity
		       , md.md_name, md.md_brand, md.md_price, md.md_image_url
		FROM tb_cart car, tb_md md
		WHERE car.md_no = md.md_no
		AND car.order_type = '개별구매'
		AND car.member_no = #{member_no}
	</select> 	
	
	<select id="payTotal" parameterType="map" resultType="java.util.Map">	
		SELECT 
		       DISTINCT sum(md_price*cart_quantity) OVER (PARTITION BY order_type) as order_amount
		FROM tb_cart car, tb_md md
		WHERE car.md_no = md.md_no
		AND car.order_type = '개별구매'
		AND car.member_no = #{member_no}
	</select> 	
	
	
	
	<select id="spaymentList" parameterType="map" resultType="java.util.Map">	
		SELECT car.member_no, car.cart_no, car.order_type, car.cart_quantity
		       , md.md_name, md.md_brand, md.md_price, md.md_image_url
		FROM tb_cart car, tb_md md
		WHERE car.md_no = md.md_no
		AND car.order_type = '정기구독'
		AND car.member_no = #{member_no}
	</select> 	
	
	<select id="spayTotal" parameterType="map" resultType="java.util.Map">	
		SELECT 
		       DISTINCT sum(md_price*cart_quantity) OVER (PARTITION BY order_type) as order_amount
		FROM tb_cart car, tb_md md
		WHERE car.md_no = md.md_no
		AND car.order_type = '정기구독'
		AND car.member_no = #{member_no}
	</select> 	
	
	<insert id="requestPay" parameterType="map">
    	INSERT into tb_iamport(pg, pay_method, merchant_uid, name, amount, buyer_name, buyer_tel
    						   , buyer_email, buyer_addr, order_type, pay_date) 
    	VALUES (#{pg}, #{pay_method}, #{merchant_uid}, #{name}, #{amount}, #{buyer_name}
    			, #{buyer_tel}, #{buyer_email}, #{buyer_addr}, #{order_type}, #{pay_date}
    			, to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS'))
    </insert>
	
	</mapper>